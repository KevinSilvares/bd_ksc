# PR0205: Escritura de datos en InfluxDB


```python
import psutil
import time

# Obtener estadísticas de uso
def obtener_metricas_sistema(host_id):
    # Uso de CPU (promedio de los últimos segundos)
    cpu_usage = psutil.cpu_percent(interval=1)
    
    # Uso de RAM
    mem = psutil.virtual_memory()
    ram_used_gb = round(mem.used / (1024**3), 2) # Conversión a GB
    ram_percent = mem.percent
    
    # Uso de disco (en el punto de montaje raíz)
    disk = psutil.disk_usage('/')
    disk_percent = disk.percent
    
    return {
        'host': host_id,
        'cpu_percent': cpu_usage,
        'ram_used_gb': ram_used_gb,
        'ram_percent': ram_percent,
        'disk_percent': disk_percent
    }
```


```python
def measure():
    while True:
        metrics = obtener_metricas_sistema("servidor_01")

        p = Point("system_metrics") \
            .tag("host_id", metrics["host"]) \
            .tag("entorno", "produccion") \
            .field("cpu_percent", metrics["cpu_percent"]) \
            .field("ram_percent", metrics["ram_percent"]) \
            .field("disk_percent", metrics["disk_percent"]) \
            .time(None)
    
        write_api.write(bucket = "bucket_prueba", org = "docs", record = p)

        # Espera un segundo por cada iteración
        time.sleep(1)
```


```python
import influxdb_client
from influxdb_client.client.write_api import ASYNCHRONOUS
from influxdb_client import WriteOptions
from influxdb_client.client.exceptions import InfluxDBError
from influxdb_client import Point
from urllib3.exceptions import NewConnectionError
import time

INFLUX_URL = "http://influxdb2:8086"
INFLUX_TOKEN = "MyInitialAdminToken0=="

print("--- Iniciando conexión a InfluxDB ---")

client = None
try:
    # 1. Inicializar el cliente
    client = influxdb_client.InfluxDBClient(
        url=INFLUX_URL,
        token=INFLUX_TOKEN,
        org="docs"
    )

    # 2. Verificar la conexión con el servidor
    print(f"Verificando estado de salud de InfluxDB en {INFLUX_URL}...")
    health = client.health()
    
    if health.status == "pass":
        print("[INFO] ¡Conexión exitosa!")
        print(f"[INFO]  Versión del servidor: {health.version}")

        write_options = WriteOptions(
            batch_size = 500,
            flush_interval = 1000,
            write_type = ASYNCHRONOUS
        )
        write_api = client.write_api(write_options = write_options)
        
        measure()
    else:
        print(f"[ERROR] Conexión fallida. Estado: {health.status}")
        print(f"[INFO] Mensaje: {health.message}")

except (InfluxDBError, NewConnectionError, KeyboardInterrupt) as e:
    print("[ERROR] Error al conectar con InfluxDB:")
    print(f"   Detalle: {e}")
    
finally:
    # 3. Es buena práctica cerrar siempre el cliente
    if write_api:
        write_api.close()    
    if client:
        client.close()
        print("--- Conexión cerrada ---")
```

    --- Iniciando conexión a InfluxDB ---
    Verificando estado de salud de InfluxDB en http://influxdb2:8086...
    [INFO] ¡Conexión exitosa!
    [INFO]  Versión del servidor: v2.7.12
    [ERROR] Error al conectar con InfluxDB:
       Detalle: 
    --- Conexión cerrada ---

